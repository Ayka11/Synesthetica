{% extends "layout.html" %}

{% block title %}Create - Synesthetica{% endblock %}

{% block head %}
<script src="/static/realtime-audio.js"></script>
<style>
  /* Custom scrollbar for sidebars */
  .sidebar-scroll::-webkit-scrollbar { width: 4px; }
  .sidebar-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
  .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  
  /* Glassmorphism utility */
  .glass-panel {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.5);
  }
  .dark .glass-panel {
    background: rgba(31, 41, 55, 0.85);
    border-color: rgba(55, 65, 81, 0.5);
  }

  /* Canvas Cursor */
  #canvas { cursor: crosshair; touch-action: none; }
  
  /* Selection Glow */
  .selected-tool {
    border-color: #4f46e5;
    background-color: rgba(79, 70, 229, 0.1);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
  }
  .dark .selected-tool {
    border-color: #818cf8;
    background-color: rgba(129, 140, 248, 0.15);
  }
  
  /* Transitions */
  .sidebar-transition { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
</style>
{% endblock %}

{% block content %}
<div class="relative flex h-[calc(100vh-64px)] overflow-hidden bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

  <!-- ================= LEFT SIDEBAR: BRUSHES ================= -->
  <aside id="leftSidebar" class="absolute inset-y-0 left-0 z-30 flex flex-col w-80 glass-panel border-r border-gray-200 dark:border-gray-700 sidebar-transition transform -translate-x-full md:relative md:translate-x-0">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider flex items-center gap-2">
        <svg class="w-5 h-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
        Brushes
      </h2>
      <button onclick="toggleSidebar('left')" class="md:hidden text-gray-500 hover:text-indigo-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
    </div>

    <!-- Brush List -->
    <div class="flex-1 overflow-y-auto p-4 space-y-3 sidebar-scroll">
      <div id="brushList" class="space-y-2">
        <!-- Generated by JS -->
      </div>

      <!-- Settings Divider -->
      <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>

      <!-- Brush Size -->
      <div class="space-y-2">
        <div class="flex justify-between text-xs font-medium text-gray-500 dark:text-gray-400">
          <span>Size</span>
          <span id="brushSizeVal">16px</span>
        </div>
        <input type="range" id="brushSizeSlider" min="4" max="64" value="16" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-600">
      </div>

      <!-- Color Picker -->
      <div class="mt-4">
        <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Active Color</label>
        <div class="flex items-center gap-3 mt-2">
          <input type="color" id="colorPicker" value="#4f46e5" class="h-10 w-full rounded-lg cursor-pointer border border-gray-200 dark:border-gray-700 p-1 bg-white dark:bg-gray-800">
        </div>
      </div>
      
      <!-- Actions -->
      <div class="grid grid-cols-2 gap-2 mt-4">
        <button onclick="undo()" class="p-2 text-xs font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition">â†© Undo</button>
        <button onclick="clearCanvas()" class="p-2 text-xs font-medium text-red-600 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 transition">ðŸ—‘ Clear</button>
      </div>
    </div>
  </aside>

  <!-- ================= MAIN CANVAS AREA ================= -->
  <main class="flex-1 relative flex flex-col">
    <!-- Toggle Buttons (Visible when sidebars collapsed on Mobile or Desktop) -->
    <div class="absolute top-4 left-4 z-20 md:hidden">
      <button onclick="toggleSidebar('left')" class="p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg text-indigo-600 hover:scale-110 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
    <div class="absolute top-4 right-4 z-20 md:hidden">
      <button onclick="toggleSidebar('right')" class="p-3 bg-white dark:bg-gray-800 rounded-full shadow-lg text-purple-600 hover:scale-110 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
      </button>
    </div>

    <!-- Canvas Container -->
    <div class="flex-1 flex items-center justify-center p-4 bg-dots-pattern relative">
      <div class="relative w-full max-w-5xl aspect-video bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-200 dark:border-gray-700 group">
        <canvas id="canvas" width="1000" height="562" class="w-full h-full"></canvas>
        
        <!-- Hover Hint -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-black/70 backdrop-blur text-white text-xs rounded-full opacity-0 group-hover:opacity-100 transition duration-500 pointer-events-none">
          Click & Drag to Paint â€¢ Use Touch for Chords
        </div>
      </div>
    </div>

    <!-- Bottom Palette Bar -->
    <div class="h-16 glass-panel border-t border-gray-200 dark:border-gray-700 flex items-center px-4 overflow-x-auto space-x-2 scrollbar-hide shrink-0" id="paletteBar">
      <!-- Generated by JS -->
    </div>
  </main>

  <!-- ================= RIGHT SIDEBAR: INSTRUMENTS ================= -->
  <aside id="rightSidebar" class="absolute inset-y-0 right-0 z-30 flex flex-col w-80 glass-panel border-l border-gray-200 dark:border-gray-700 sidebar-transition transform translate-x-full md:relative md:translate-x-0">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wider flex items-center gap-2">
        <svg class="w-5 h-5 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
        Instruments
      </h2>
      <button onclick="toggleSidebar('right')" class="md:hidden text-gray-500 hover:text-purple-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
    </div>

    <!-- Instrument List -->
    <div class="flex-1 overflow-y-auto p-4 space-y-3 sidebar-scroll">
      <div id="instrumentList" class="space-y-2">
        <!-- Generated by JS -->
      </div>

      <!-- Audio Settings -->
      <div class="border-t border-gray-200 dark:border-gray-700 my-4"></div>
      
      <div class="space-y-4">
        <div class="space-y-2">
          <div class="flex justify-between text-xs font-medium text-gray-500 dark:text-gray-400">
            <span>Reverb</span>
            <span id="reverbVal">20%</span>
          </div>
          <input type="range" id="reverbSlider" min="0" max="1" step="0.1" value="0.2" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-600">
        </div>

        <div class="space-y-2">
          <div class="flex justify-between text-xs font-medium text-gray-500 dark:text-gray-400">
            <span>BPM (Grid Brush)</span>
            <span id="bpmVal">120</span>
          </div>
          <input type="range" id="bpmSlider" min="40" max="240" value="120" class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-pink-600">
        </div>
        
        <div class="space-y-2">
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Musical Key</label>
            <select id="scaleSelect" class="w-full p-2 text-sm bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none">
                <option value="chromatic">Chromatic (All)</option>
                <option value="major">C Major (Happy)</option>
                <option value="minor">A Minor (Sad)</option>
                <option value="pentatonic">Pentatonic (Zen)</option>
                <option value="blues">Blues (Soul)</option>
                <option value="dorian">Dorian (Jazzy)</option>
            </select>
        </div>
      </div>
    </div>

    <!-- Generate Button -->
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
      <button onclick="submitDrawing()" id="generateBtn" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-bold shadow-lg transform transition hover:scale-[1.02] flex items-center justify-center gap-2">
        <span>âœ¨</span> Generate Full Song
      </button>
      <div class="flex justify-center mt-3 gap-4 text-xs text-gray-500">
        <a id="dlWav" href="#" class="hidden hover:text-indigo-600 flex items-center gap-1">â¬‡ WAV</a>
        <a id="dlMidi" href="#" class="hidden hover:text-purple-600 flex items-center gap-1">â¬‡ MIDI</a>
      </div>
      <audio id="player" controls class="hidden w-full mt-3 h-8"></audio>
    </div>
  </aside>

  <!-- Upload Modal (Hidden) -->
  <div id="uploadModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 relative">
        <button onclick="document.getElementById('uploadModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Upload Image</h3>
        <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
        <div class="mt-4 flex justify-end gap-2">
            <button onclick="setMode('timeline'); quickPreview();" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200">Preview</button>
            <button onclick="generateFullAudio()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Generate Full</button>
        </div>
        <img id="imagePreview" class="mt-4 max-h-48 rounded-lg mx-auto hidden">
    </div>
  </div>

</div>

<!-- Toast -->
<div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-900/90 dark:bg-white/90 backdrop-blur text-white dark:text-gray-900 px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-sm font-medium">
  Notification
</div>

{% endblock %}

{% block scripts %}
<script>
// --- Data ---
const brushes = [
  { id: 'round', name: 'Round', desc: 'Pure Tone', icon: 'â—' },
  { id: 'square', name: 'Square', desc: 'Digital/Harsh', icon: 'â– ' },
  { id: 'sawtooth', name: 'Sawtooth', desc: 'Bright/Buzzy', icon: 'âš¡' },
  { id: 'triangle', name: 'Triangle', desc: 'Soft/Mellow', icon: 'â–²' },
  { id: 'star', name: 'Star', desc: 'Harmonics', icon: 'â˜…' },
  { id: 'cross', name: 'Cross', desc: 'Detuned Beat', icon: 'âœ–' },
  { id: 'spray', name: 'Spray', desc: 'FM Wobble', icon: 'â˜' }
];

const instruments = [
  { id: 'sine', name: 'Pure Sine', desc: 'Flute-like' },
  { id: 'piano', name: 'Warm Piano', desc: 'Acoustic' },
  { id: 'rhodes', name: 'Elec. Rhodes', desc: 'Vintage' },
  { id: 'strings', name: 'Strings Pad', desc: 'Ensemble' },
  { id: 'bell', name: 'FM Bell', desc: 'Crystalline' },
  { id: 'retro', name: 'Retro 8-Bit', desc: 'Chiptune' },
  { id: 'soft_saw', name: 'Soft Saw', desc: 'Synth Lead' }
];

// --- Palettes Logic ---
// --- Note Mapping Logic ---
const NOTE_FREQS = {
    'A0': 27.50, 'A#0': 29.14, 'B0': 30.87,
    'C1': 32.70, 'C#1': 34.65, 'D1': 36.71, 'D#1': 38.89, 'E1': 41.20, 'F1': 43.65, 'F#1': 46.25, 'G1': 49.00, 'G#1': 51.91, 'A1': 55.00, 'A#1': 58.27, 'B1': 61.74,
    'C4': 261.63, 'A4': 440.00, 'C5': 523.25, 'E5': 659.25, 'A5': 880.00, 'C8': 4186.01
};

function getNoteName(freq) {
    if (!freq) return '?';
    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const midi = Math.round(69 + 12 * Math.log2(freq / 440));
    const octave = Math.floor(midi / 12) - 1;
    const note = notes[midi % 12];
    return `${note}${octave}`;
}

// Helper: Get Frequency from Hex (Reuse server logic approximation)
function getFreqFromHex(hex) {
    if (!window.realTimeAudio) return 440;
    const r = parseInt(hex.substr(1,2), 16);
    const g = parseInt(hex.substr(3,2), 16);
    const b = parseInt(hex.substr(5,2), 16);
    return window.realTimeAudio.getFrequencyFromColor(r,g,b);
}

const palettes = [
  { 
    name: "Piano (Classic)", 
    colors: ["#3E2723", "#D7CCC8", "#5D4037", "#A1887F", "#795548"], 
    instrument: "piano", 
    desc: "Warm Browns â€¢ C4-C6 Range" 
  },
  { 
    name: "Strings (Orchestra)", 
    colors: ["#880E4F", "#B71C1C", "#FFD700", "#4A148C", "#AD1457"], 
    instrument: "strings", 
    desc: "Deep Reds/Golds â€¢ A2-E5 Range" 
  },
  { 
    name: "Synth Lead (Neon)", 
    colors: ["#00E676", "#2979FF", "#D500F9", "#FFEA00", "#FF1744"], 
    instrument: "soft_saw", 
    desc: "High Energy â€¢ A5-C8 Range" 
  },
  { 
    name: "Bass (Deep)", 
    colors: ["#212121", "#37474F", "#263238", "#455A64", "#546E7A"], 
    instrument: "sine", 
    desc: "Sub Frequencies â€¢ A0-C3 Range" 
  },
  { 
    name: "Bells (Mystic)", 
    colors: ["#E0F7FA", "#B2EBF2", "#80DEEA", "#4DD0E1", "#26C6DA"], 
    instrument: "bell", 
    desc: "Metallic Highs â€¢ C5-C7 Range" 
  },
  { 
    name: "Retro (Chiptune)", 
    colors: ["#0D47A1", "#1976D2", "#1565C0", "#0D47A1", "#82B1FF"], 
    instrument: "retro", 
    desc: "Square Waves â€¢ Mid Range" 
  }
];

// --- State ---
window.drawing = false;
let currentBrush = 'round';
let currentInstrument = 'sine';
let currentColor = '#4f46e5';
let brushSize = 16;

// --- Init UI ---
function renderUI() {
  // Brushes
  const brushList = document.getElementById('brushList');
  brushList.innerHTML = brushes.map(b => `
    <div onclick="selectBrush('${b.id}')" id="brush-${b.id}" class="cursor-pointer p-3 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition group ${b.id === currentBrush ? 'selected-tool' : ''}">
      <div class="flex items-center gap-3">
        <span class="text-xl text-gray-600 dark:text-gray-300">${b.icon}</span>
        <div>
          <div class="text-sm font-semibold text-gray-900 dark:text-white">${b.name}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${b.desc}</div>
        </div>
      </div>
    </div>
  `).join('');

  // Instruments
  const instList = document.getElementById('instrumentList');
  instList.innerHTML = instruments.map(i => `
    <div onclick="selectInstrument('${i.id}')" id="inst-${i.id}" class="cursor-pointer p-3 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-purple-50 dark:hover:bg-purple-900/30 transition group ${i.id === currentInstrument ? 'selected-tool' : ''}">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-100 to-gray-300 dark:from-gray-700 dark:to-gray-600 flex items-center justify-center">
            <span class="text-xs">â™ª</span>
        </div>
        <div>
          <div class="text-sm font-semibold text-gray-900 dark:text-white">${i.name}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${i.desc}</div>
        </div>
      </div>
    </div>
  `).join('');

  // Palettes
  renderPalettes();
}

// --- Actions ---
window.selectBrush = (id) => {
  currentBrush = id;
  window.tool = id; // Sync with legacy global
  renderUI(); // Re-render to update active class
  // showToast(`Brush: ${brushes.find(b=>b.id===id).name}`);
};

window.selectInstrument = (id) => {
  currentInstrument = id;
  if(window.realTimeAudio) window.realTimeAudio.setInstrument(id);
  renderUI();
  showToast(`Instrument: ${instruments.find(i=>i.id===id).name}`);
};

window.setColor = (hex) => {
  currentColor = hex;
  document.getElementById('colorPicker').value = hex;
};

window.toggleSidebar = (side) => {
  const el = document.getElementById(`${side}Sidebar`);
  if(side === 'left') {
    el.classList.toggle('-translate-x-full');
  } else {
    el.classList.toggle('translate-x-full');
  }
};

window.showToast = (msg) => {
  const t = document.getElementById('toast');
  t.innerText = msg;
  t.classList.remove('opacity-0');
  setTimeout(() => t.classList.add('opacity-0'), 2000);
};

// --- Canvas & Audio Integration ---
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let isPainting = false;

// Initialize
renderUI();
ctx.fillStyle = 'white';
ctx.fillRect(0,0,1000,562);

// Event Listeners
canvas.addEventListener('mousedown', startPaint);
canvas.addEventListener('mousemove', paint);
window.addEventListener('mouseup', () => { isPainting = false; ctx.beginPath(); });

canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startPaint(e.touches[0]); }, {passive:false});
canvas.addEventListener('touchmove', (e) => { e.preventDefault(); paint(e.touches[0]); }, {passive:false});

function startPaint(e) {
  isPainting = true;
  paint(e);
}

function paint(e) {
  if(!isPainting) return;
  
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = (e.clientX - rect.left) * scaleX;
  const y = (e.clientY - rect.top) * scaleY;

  ctx.fillStyle = currentColor;
  ctx.strokeStyle = currentColor;
  ctx.lineWidth = brushSize;
  ctx.lineCap = 'round';

  // Visuals
  if(currentBrush === 'round' || currentBrush === 'star') {
      ctx.beginPath(); ctx.arc(x,y, brushSize/2, 0, Math.PI*2); ctx.fill();
  } else if (currentBrush === 'square') {
      ctx.fillRect(x-brushSize/2, y-brushSize/2, brushSize, brushSize);
  } else {
      ctx.beginPath(); ctx.arc(x,y, brushSize/2, 0, Math.PI*2); ctx.fill(); // Default fallback
  }

  // Audio
  if(window.realTimeAudio) {
      const r = parseInt(currentColor.substr(1,2), 16);
      const g = parseInt(currentColor.substr(3,2), 16);
      const b = parseInt(currentColor.substr(5,2), 16);
      window.realTimeAudio.playColorNote(r, g, b, currentBrush, x, canvas.width);
  }
}

// Controls
document.getElementById('brushSizeSlider').addEventListener('input', (e) => {
    brushSize = parseInt(e.target.value);
    document.getElementById('brushSizeVal').innerText = brushSize + 'px';
});

document.getElementById('colorPicker').addEventListener('input', (e) => currentColor = e.target.value);

document.getElementById('reverbSlider').addEventListener('input', (e) => {
    if(window.realTimeAudio) window.realTimeAudio.setReverbMix(parseFloat(e.target.value));
    document.getElementById('reverbVal').innerText = Math.round(e.target.value * 100) + '%';
});

document.getElementById('scaleSelect').addEventListener('change', (e) => {
    if(window.realTimeAudio) window.realTimeAudio.setScale(e.target.value);
});

// Submit Logic
window.submitDrawing = async () => {
    const btn = document.getElementById('generateBtn');
    btn.innerHTML = `<span class="animate-spin">â†»</span> Generating...`;
    btn.disabled = true;
    
    try {
        const res = await fetch('/submit', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                image: canvas.toDataURL(),
                brush: currentBrush,
                instrument: currentInstrument
            })
        });
        const data = await res.json();
        
        const player = document.getElementById('player');
        player.src = data.url;
        player.classList.remove('hidden');
        player.play();
        
        document.getElementById('dlWav').href = data.url;
        document.getElementById('dlWav').classList.remove('hidden');
        
        if(data.midi_url) {
            document.getElementById('dlMidi').href = data.midi_url;
            document.getElementById('dlMidi').classList.remove('hidden');
        }
        showToast('Song Generated!');
    } catch(e) {
        showToast('Error generating song');
        console.error(e);
    } finally {
        btn.innerHTML = `<span>âœ¨</span> Generate Full Song`;
        btn.disabled = false;
    }
};

window.undo = () => { /* Add undo logic if needed */ };
window.clearCanvas = () => { ctx.fillStyle='white'; ctx.fillRect(0,0,canvas.width,canvas.height); };

// Init Realtime Audio defaults
setTimeout(() => {
    if(window.realTimeAudio) {
        window.realTimeAudio.setInstrument(currentInstrument);
    }
}, 500);

</script>
{% endblock %}
