<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Support – #{{ short_id|default('Ticket') }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col h-screen m-0 p-0">
  <!-- Header -->
  <header class="bg-[#075E54] text-white p-3 flex items-center justify-between shadow-lg">
    <div class="flex items-center space-x-3">
      <a href="/support" class="text-white hover:opacity-80">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </a>
      <div class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-full bg-[#128C7E] flex items-center justify-center font-bold text-lg">
          {{ (short_id|default('?'))[0]|upper }}
        </div>
        <div>
          <p class="font-semibold">Ticket #{{ short_id|default('????') }}</p>
          <p class="text-xs opacity-80">{{ category|default('General') }} • {{ status|default('Open') }}</p>
        </div>
      </div>
    </div>
    <div class="flex items-center space-x-3 text-sm">
      {% if user %}
        <span class="hidden sm:inline">Hi, {{ user.name }}</span>
        <a href="/logout" class="hover:underline">Logout</a>
      {% else %}
        <a href="/auth" class="hover:underline">Login</a>
      {% endif %}
    </div>
  </header>

  <!-- Messages -->
  <div id="chatBox" class="flex-1 overflow-y-auto p-4 space-y-4" style="max-height:calc(100vh-120px);">
    {% if chat %}
      {% for msg in chat %}
        {% if msg.sender == 'user' %}
          <div class="flex justify-end mb-3">
            <div class="max-w-[75%]">
              <div class="msg-bubble msg-user text-gray-900 shadow-sm">
                {{ msg.user | safe }}
                <div class="msg-time">
                  {{ (msg.time.split('T')[1][:5]) if msg.time else 'Now' }}
                </div>
              </div>
            </div>
          </div>
        {% elif msg.sender == 'support' %}
          <div class="flex justify-start mb-3">
            <div class="max-w-[75%]">
              <div class="msg-bubble msg-admin text-gray-900 shadow-sm">
                {{ msg.assistant | safe }}
                <div class="msg-time">
                  {{ (msg.time.split('T')[1][:5]) if msg.time else 'Now' }}
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="text-center text-gray-600 italic mt-10">No messages yet. Start the conversation!</p>
    {% endif %}
  </div>

  <!-- Input -->
  <form id="replyForm" class="bg-[#F0F0F0] border-t border-gray-300 p-3 flex items-center space-x-2">
    <div class="flex-1 bg-white rounded-full shadow-sm flex items-center px-3 py-2">
      <textarea 
        id="replyText" 
        rows="1" 
        placeholder="Type a message..." 
        class="flex-1 resize-none border-none outline-none text-sm text-gray-800" 
        required
      ></textarea>
    </div>
    <button type="submit" class="bg-[#25D366] hover:bg-[#1EBE5D] text-white rounded-full p-3 shadow-md transition">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
      </svg>
    </button>
  </form>

  <div id="replyResult" class="hidden p-2"></div>

  <script>
    const escapeHtml = t => { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; };
    const addBubble = (txt, isUser) => {
      const box = document.getElementById('chatBox');
      const time = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      box.insertAdjacentHTML('beforeend', `
        <div class="flex ${isUser?'justify-end mb-3':'justify-start mb-3'}">
          <div class="max-w-[75%]">
            <div class="msg-bubble ${isUser?'msg-user':'msg-admin'} text-gray-900 shadow-sm">
              ${escapeHtml(txt)}
              <div class="msg-time">${time}</div>
            </div>
          </div>
        </div>`);
      box.scrollTop = box.scrollHeight;
    };
   const sendReply = async () => {
  const txt = document.getElementById('replyText').value.trim();
  if (!txt) return;
  addBubble(txt, true); // true = user = right
  document.getElementById('replyText').value = '';
  try {
    const res = await fetch('/api/support/{{ short_id }}/reply', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reply: txt })
    });
    // ... error handling
  } catch (e) {
    console.error(e);
  }
};
    document.getElementById('replyForm').onsubmit = e=>{e.preventDefault(); sendReply();};
    document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
  </script>
</body>
</html>
