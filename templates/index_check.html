{% extends "layout.html" %}

{% block title %}Create - Synesthetica{% endblock %}

{% block head %}
<script src="/static/realtime-audio.js"></script>
<style>
  /* Custom slider styling */
  input[type=range] {
    -webkit-appearance: none; 
    background: transparent; 
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 16px;
    width: 16px;
    border-radius: 50%;
    background: #4f46e5;
    cursor: pointer;
    margin-top: -6px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  input[type=range]::-webkit-slider-runnable-track {
    width: 100%;
    height: 4px;
    cursor: pointer;
    background: #e5e7eb;
    border-radius: 2px;
  }
  
  /* Canvas transitions */
  canvas {
    touch-action: none;
  }
  
  /* Chat widget animations */
  #chatWindow {
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
  }
</style>
{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen pb-20">
  
  <!-- Hero / Intro Section -->
  <section id="heroSection" class="relative bg-white overflow-hidden">
    <div class="max-w-7xl mx-auto">
      <div class="relative z-10 pb-8 bg-white sm:pb-16 md:pb-20 lg:max-w-2xl lg:w-full lg:pb-28 xl:pb-32">
        <svg class="hidden lg:block absolute right-0 inset-y-0 h-full w-48 text-white transform translate-x-1/2" fill="currentColor" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true">
          <polygon points="50,0 100,0 50,100 0,100" />
        </svg>

        <main class="mt-10 mx-auto max-w-7xl px-4 sm:mt-12 sm:px-6 md:mt-16 lg:mt-20 lg:px-8 xl:mt-28">
          <div class="sm:text-center lg:text-left">
            <h1 class="text-4xl tracking-tight font-extrabold text-gray-900 sm:text-5xl md:text-6xl">
              <span class="block xl:inline">Create art that</span>
              <span class="block text-indigo-600 xl:inline">actually sings</span>
            </h1>
            <p class="mt-3 text-base text-gray-500 sm:mt-5 sm:text-lg sm:max-w-xl sm:mx-auto md:mt-5 md:text-xl lg:mx-0">
              Transform your brush strokes into beautiful musical tones. Every color becomes a note, every shape a melody. Experience synesthesia.
            </p>
            <div class="mt-5 sm:mt-8 sm:flex sm:justify-center lg:justify-start">
              <div class="rounded-md shadow">
                <button onclick="scrollToApp()" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 md:py-4 md:text-lg md:px-10 transition-all">
                  Start Creating
                </button>
              </div>
              <div class="mt-3 sm:mt-0 sm:ml-3">
                <button onclick="toggleBrushPreview()" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 md:py-4 md:text-lg md:px-10 transition-all">
                  Learn More
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
    <div class="lg:absolute lg:inset-y-0 lg:right-0 lg:w-1/2 bg-indigo-50 flex items-center justify-center">
      <img class="h-56 w-full object-cover sm:h-72 md:h-96 lg:w-full lg:h-full opacity-80" src="https://images.unsplash.com/photo-1550684848-fac1c5b4e853?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Abstract colorful sound waves">
    </div>
  </section>

  <!-- Brush Preview Section (Hidden by default) -->
  <section id="brushPreviewSection" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 bg-gray-50 transition-all duration-500">
    <div class="text-center mb-10">
      <h2 class="text-3xl font-extrabold text-gray-900">The Sound of Brushes</h2>
      <p class="mt-4 text-lg text-gray-500">Each brush shape generates a unique waveform, creating different textures.</p>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="text-indigo-500 mb-2">‚óè Round</div>
        <h3 class="font-bold text-gray-900">Sine Wave</h3>
        <p class="text-sm text-gray-500">Pure, smooth, flute-like tone.</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="text-indigo-500 mb-2">‚ñ† Square</div>
        <h3 class="font-bold text-gray-900">Square Wave</h3>
        <p class="text-sm text-gray-500">Hollow, woody, retro-game sound.</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="text-indigo-500 mb-2">‚ñ≤ Triangle</div>
        <h3 class="font-bold text-gray-900">Triangle Wave</h3>
        <p class="text-sm text-gray-500">Bright but soft, like a trumpet.</p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
        <div class="text-indigo-500 mb-2">‚ö° Sawtooth</div>
        <h3 class="font-bold text-gray-900">Sawtooth Wave</h3>
        <p class="text-sm text-gray-500">Buzzy, sharp, string-like sound.</p>
      </div>
    </div>
  </section>

  <!-- Main Drawing App -->
  <div id="drawingApp" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-12 scroll-mt-24">
    
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
      <!-- Toolbar -->
      <div class="bg-gray-50 border-b border-gray-200 p-4 flex flex-col md:flex-row items-center justify-between gap-4">
        
        <!-- Left: Brush Controls -->
        <div class="flex items-center gap-6 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
            <div class="flex flex-col">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Instrument</label>
                <select id="instrumentSelect" class="block w-32 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm bg-white">
                  <option value="sine">Sine (Flute)</option>
                  <option value="piano">Piano</option>
                  <option value="guitar">Guitar</option>
                  <option value="strings">Strings</option>
                  <option value="triangle">Triangle</option>
                  <option value="sawtooth">Sawtooth</option>
                  <option value="square">Square</option>
                </select>
            </div>

            <div class="flex flex-col">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Brush Type</label>
                <select id="toolSelect" class="block w-32 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm bg-white">
                  <option value="round">Round (Sine)</option>
                  <option value="square">Square</option>
                  <option value="triangle">Triangle</option>
                  <option value="sawtooth">Sawtooth</option>
                  <option value="star">Star (Harmonics)</option>
                  <option value="spray">Spray (Noise)</option>
                  <option value="line">Line</option>
                  <option value="cross">Cross (FM)</option>
                </select>
            </div>
            
            <div class="flex flex-col w-32">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Size: <span id="brushSizeVal">16</span>px</label>
                <input type="range" id="brushSizeSlider" min="4" max="64" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <div class="flex flex-col">
                 <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Color</label>
                 <div class="flex items-center gap-2">
                    <input type="color" id="colorPicker" value="#4f46e5" class="h-9 w-9 p-0 border-0 rounded-md cursor-pointer shadow-sm">
                 </div>
            </div>
        </div>

        <!-- Right: Actions -->
        <div class="flex items-center gap-2">
            <button onclick="undo()" class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-gray-100 rounded-full transition-colors" title="Undo">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
            </button>
            <button onclick="redo()" class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-gray-100 rounded-full transition-colors" title="Redo">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6"></path></svg>
            </button>
  <!-- Upload Section (Hidden by default, toggled via JS) -->
  <section id="uploadSection" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 bg-white transition-all duration-500">
    <div class="max-w-3xl mx-auto">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-extrabold text-gray-900">Upload & Sonify</h2>
            <p class="mt-2 text-lg text-gray-500">Turn any image into a soundscape.</p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200 p-8">
            <!-- Upload Area -->
            <div id="dropZone" class="border-2 border-dashed border-indigo-300 rounded-xl p-8 text-center hover:bg-indigo-50 transition-colors cursor-pointer relative">
                <input type="file" id="imageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="space-y-4 pointer-events-none">
                    <svg class="mx-auto h-12 w-12 text-indigo-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-gray-600">Drag & drop an image here, or click to select</p>
                    <p class="text-sm text-gray-400">JPG, PNG, WEBP up to 5MB</p>
                </div>
            </div>

            <!-- Preview & Controls (Hidden initially) -->
            <div id="uploadControls" class="hidden mt-8 space-y-6">
                <div class="flex justify-center">
                    <img id="imagePreview" class="max-h-64 rounded-lg shadow-md object-contain" src="" alt="Preview">
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-4 items-center">
                    <div class="flex items-center space-x-2 bg-gray-100 p-1 rounded-lg">
                        <button onclick="setMode('timeline')" id="btnTimeline" class="px-4 py-2 rounded-md text-sm font-medium bg-white shadow-sm text-indigo-600 transition-all">Timeline Mode</button>
                        <button onclick="setMode('colorfield')" id="btnColorField" class="px-4 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-900 transition-all">Color Field</button>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button onclick="quickPreview()" class="px-6 py-3 border border-indigo-600 text-indigo-600 font-medium rounded-full hover:bg-indigo-50 transition-colors flex items-center justify-center gap-2">
                        <span>‚ö°</span> Quick Preview
                    </button>
                    <button onclick="generateFullAudio()" class="px-6 py-3 bg-indigo-600 text-white font-medium rounded-full hover:bg-indigo-700 shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
                        <span>üéµ</span> Generate Full Audio
                    </button>
                </div>

                <!-- Results -->
                <div id="uploadResults" class="hidden mt-6 bg-gray-50 rounded-xl p-4">
                    <div class="text-center mb-4">
                        <h3 class="font-bold text-gray-900">Result</h3>
                    </div>
                    <audio id="uploadPlayer" controls class="w-full mb-4"></audio>
                    <div class="flex justify-center gap-4">
                        <a id="dlWav" href="#" download class="text-sm text-indigo-600 hover:underline flex items-center gap-1">‚¨á WAV</a>
                        <a id="dlMidi" href="#" download class="text-sm text-indigo-600 hover:underline flex items-center gap-1">‚¨á MIDI</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </section>
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            <button onclick="clearCanvas()" class="p-2 text-red-500 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors" title="Clear Canvas">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
            <button onclick="saveImage()" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-full transition-colors" title="Save Image">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
      </div>

      <!-- Canvas Area -->
      <div class="relative bg-white" style="cursor: crosshair;">
        <canvas id="canvas" class="w-full h-[400px] md:h-[500px] block" width="1000" height="500"></canvas>
        <div class="absolute bottom-2 left-0 right-0 text-center pointer-events-none">
            <span class="text-xs text-gray-400 bg-white/80 px-2 py-1 rounded">Time Axis (seconds) &rarr;</span>
        </div>
      </div>

      <!-- Footer / Presets -->
      <div class="bg-gray-50 p-4 border-t border-gray-200">
        <div class="flex flex-wrap justify-center gap-2 mb-4">
             <button onclick="setColor('#80E000')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#80E000" title="C4"></button>
             <button onclick="setColor('#006073')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#006073" title="D4"></button>
             <button onclick="setColor('#7e00d9')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#7e00d9" title="E4"></button>
             <button onclick="setColor('#9F1AEC')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#9F1AEC" title="F4"></button>
             <button onclick="setColor('#D91A80')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#D91A80" title="G4"></button>
             <button onclick="setColor('#F95700')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#F95700" title="A4"></button>
             <button onclick="setColor('#ffff33')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#ffff33" title="B4"></button>
             <button onclick="setColor('#3399CC')" class="w-8 h-8 rounded-full border-2 border-white shadow-sm hover:scale-110 transition-transform" style="background:#3399CC" title="C5"></button>
        </div>

        <div class="flex justify-center gap-4">
            <button onclick="submitDrawing()" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all hover:scale-105">
                <span class="mr-2">üéº</span> Generate Sound
            </button>
            <button onclick="downloadAudio()" id="downloadBtn" disabled class="inline-flex items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-full shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all opacity-50 cursor-not-allowed">
                <span class="mr-2">üíæ</span> Download WAV
            </button>
        </div>
        
        <div class="mt-6 flex justify-center">
            <audio id="player" controls class="w-full max-w-md"></audio>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="fixed top-20 right-5 z-50 flex flex-col gap-2"></div>

  <!-- Chat Widget -->
  <div class="fixed bottom-5 right-5 z-50">
      <button onclick="toggleChat()" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
      </button>

      <div id="chatWindow" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col" style="height: 400px;">
          <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
              <h3 class="font-bold">Support Chat</h3>
              <button onclick="toggleChat()" class="hover:text-gray-200">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
          </div>
          <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50">
              <div class="flex flex-col items-start">
                  <div class="bg-indigo-100 text-indigo-900 rounded-lg rounded-tl-none px-4 py-2 text-sm max-w-[85%]">
                      Hello! How can I help you create today?
                  </div>
                  <span class="text-xs text-gray-400 mt-1 ml-1">Bot</span>
              </div>
          </div>
          <div class="p-3 border-t border-gray-200 bg-white">
              <div class="flex gap-2">
                  <input type="text" id="chatInput" placeholder="Type a message..." class="flex-1 border border-gray-300 rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                  <button onclick="sendMessage()" class="bg-indigo-600 text-white rounded-full p-2 hover:bg-indigo-700 transition-colors">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                  </button>
              </div>
          </div>
      </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // --- UI Functions ---
    function scrollToApp() {
        document.getElementById('drawingApp').scrollIntoView({ behavior: 'smooth' });
    }

    function toggleBrushPreview() {
        const el = document.getElementById('brushPreviewSection');
        el.classList.toggle('hidden');
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        const bgColors = {
            'info': 'bg-blue-600',
            'error': 'bg-red-600',
            'success': 'bg-green-600',
            'warning': 'bg-yellow-500'
        };
        
        toast.className = `${bgColors[type] || bgColors.info} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full flex items-center gap-3`;
        toast.innerHTML = `<span>${message}</span>`;
        
        container.appendChild(toast);
        
        // Animate in
        requestAnimationFrame(() => {
            toast.classList.remove('translate-x-full');
        });

        // Remove after 3s
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // --- Chat Functions ---
    function toggleChat() {
        const win = document.getElementById('chatWindow');
        win.classList.toggle('hidden');
    }

    function addChatMessage(text, isUser) {
        const container = document.getElementById('chatMessages');
        const div = document.createElement('div');
        div.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = isUser 
    // --- Upload & Sonify Logic ---
    let uploadMode = 'timeline';
    let uploadedFile = null;

    function toggleSection(section) {
        const hero = document.getElementById('heroSection');
        const drawApp = document.getElementById('drawingApp');
        const uploadSec = document.getElementById('uploadSection');
        
        if (section === 'upload') {
            hero.classList.add('hidden');
            drawApp.classList.add('hidden');
            uploadSec.classList.remove('hidden');
        } else {
            hero.classList.remove('hidden');
            drawApp.classList.remove('hidden');
            uploadSec.classList.add('hidden');
        }
    }

    function setMode(mode) {
        uploadMode = mode;
        const tBtn = document.getElementById('btnTimeline');
        const cBtn = document.getElementById('btnColorField');
        
        if (mode === 'timeline') {
            tBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            tBtn.classList.remove('text-gray-500');
            cBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            cBtn.classList.add('text-gray-500');
        } else {
            cBtn.classList.add('bg-white', 'shadow-sm', 'text-indigo-600');
            cBtn.classList.remove('text-gray-500');
            tBtn.classList.remove('bg-white', 'shadow-sm', 'text-indigo-600');
            tBtn.classList.add('text-gray-500');
        }
    }

    // File Handling
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('imageInput');
    const preview = document.getElementById('imagePreview');
    const controls = document.getElementById('uploadControls');

    fileInput.addEventListener('change', handleFile);
    
    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('File too large (max 5MB)', 'error');
            return;
        }
        
        uploadedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            preview.src = e.target.result;
            controls.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // Quick Preview (Client-side)
    function quickPreview() {
        if (!uploadedFile) return;
        
        showToast('Generating preview...', 'info');
        
        const img = new Image();
        img.src = preview.src;
        img.onload = () => {
            const cvs = document.createElement('canvas');
            const ctx = cvs.getContext('2d');
            // Downscale for speed
            const w = 64;
            const h = 64;
            cvs.width = w;
            cvs.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            
            const data = ctx.getImageData(0, 0, w, h).data;
            
            // Simple sonification logic
            if (uploadMode === 'colorfield') {
                // Play random spread of notes
                for (let i=0; i<10; i++) {
                    const idx = Math.floor(Math.random() * (data.length/4)) * 4;
                    const r = data[idx];
                    const g = data[idx+1];
                    const b = data[idx+2];
                    window.realTimeAudio.playColorNote(r, g, b, 'round', Math.random()*1000, 1000);
                }
            } else {
                // Play a quick scan
                let row = Math.floor(h/2);
                for (let x=0; x<w; x+=4) { // skip pixels for speed
                    setTimeout(() => {
                        const idx = (row * w + x) * 4;
                        const r = data[idx];
                        const g = data[idx+1];
                        const b = data[idx+2];
                        window.realTimeAudio.playColorNote(r, g, b, 'round', x/w * 1000, 1000);
                    }, x * 10); // fast scan
                }
            }
        };
    }

    // Full Generation (Backend)
    async function generateFullAudio() {
        if (!uploadedFile) return;
        
        const btn = document.querySelector('button[onclick="generateFullAudio()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="animate-spin">‚Üª</span> Processing...`;
        
        const formData = new FormData();
        formData.append('image', uploadedFile);
        formData.append('mode', uploadMode);
        
        try {
            const res = await fetch('/api/sonify-upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            
            const results = document.getElementById('uploadResults');
            const player = document.getElementById('uploadPlayer');
            const dlWav = document.getElementById('dlWav');
            const dlMidi = document.getElementById('dlMidi');
            
            results.classList.remove('hidden');
            player.src = data.url;
            player.play();
            
            dlWav.href = data.url;
            dlWav.download = `sonify_${uploadMode}.wav`;
            
            if (data.midi_url) {
                dlMidi.href = data.midi_url;
                dlMidi.download = `sonify_${uploadMode}.mid`;
                dlMidi.classList.remove('hidden');
            } else {
                dlMidi.classList.add('hidden');
            }
            
            showToast('Audio Generated!', 'success');
            
        } catch (e) {
            console.error(e);
            showToast(e.message || 'Upload failed', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
            ? 'bg-indigo-600 text-white rounded-lg rounded-tr-none px-4 py-2 text-sm max-w-[85%]'
            : 'bg-indigo-100 text-indigo-900 rounded-lg rounded-tl-none px-4 py-2 text-sm max-w-[85%]';
        bubble.textContent = text;
        
        div.appendChild(bubble);
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;
        
        addChatMessage(text, true);
        input.value = '';
        
        // Mock Bot Response
        setTimeout(() => {
            let response = "That's interesting! Tell me more.";
            const lower = text.toLowerCase();
            if(lower.includes('color')) response = "Colors map to musical notes. Try Red (A4) or Blue (C5)!";
            if(lower.includes('brush')) response = "Different brushes create different sound waves. Round is smooth, Sawtooth is sharp.";
            if(lower.includes('help')) response = "You can draw on the canvas and click 'Generate Sound' to hear it.";
            
            addChatMessage(response, false);
        }, 1000);
    }
    
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // --- Canvas Logic ---
    window.canvas = document.getElementById("canvas");
    const canvas = window.canvas;
    window.ctx = canvas.getContext("2d");
    const ctx = window.ctx;
    const colorPicker = document.getElementById("colorPicker");
    const toolSelect = document.getElementById("toolSelect");
    const brushSizeSlider = document.getElementById("brushSizeSlider");
    const brushSizeVal = document.getElementById("brushSizeVal");

    window.drawing = false;
    let drawing = window.drawing;
    let currentColor = colorPicker.value;
    let brushSize = parseInt(brushSizeSlider.value, 10);
    window.tool = toolSelect.value;
    let tool = window.tool;
    
    // Update window global on change
    Object.defineProperty(window, 'drawing', {
        get: function() { return drawing; },
        set: function(val) { drawing = val; }
    });
    
    Object.defineProperty(window, 'tool', {
        get: function() { return tool; },
        set: function(val) { tool = val; }
    });

    // History for Undo/Redo
    let undoStack = [];
    let redoStack = [];

    // Resize Canvas
    function resizeCanvas() {
        const parent = canvas.parentElement;
        const temp = ctx.getImageData(0,0,canvas.width,canvas.height);
        // We keep internal resolution fixed at 1000x500 for consistency in sound generation,
        // but CSS handles the display size. 
        // If we want responsiveness, we'd scale it, but mapping pixels to time is easier with fixed width.
        // So we keep width=1000 height=500 and let CSS scale it.
    }

    // Helper: Save State
    function saveState() {
        undoStack.push(canvas.toDataURL());
        if (undoStack.length > 20) undoStack.shift();
        redoStack = [];
    }

    // Initial clear
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    saveState();

    // Events
    function startDraw(e) {
        drawing = true;
        draw(e);
    }
    
    function endDraw() {
        if(drawing) {
            drawing = false;
            ctx.beginPath();
            saveState();
        }
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        let clientX = e.clientX;
        let clientY = e.clientY;
        
        if(e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        }
        
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    // Make sure window.draw is defined before realtime-audio.js tries to wrap it
    // But realtime-audio.js is loaded in head?
    // If it's loaded in head, integrateRealTimeAudioWithDrawing runs on DOMContentLoaded.
    // This script runs at the end of body (in block content), so it runs when DOM is ready.
    // We need to ensure window.draw is defined before the integration runs.
    
    window.draw = function(e) {
        if (!drawing) return;
        e.preventDefault(); // Prevent scrolling on touch
        
        const pos = getPos(e);
        const x = pos.x;
        const y = pos.y;

        ctx.fillStyle = currentColor;
        ctx.strokeStyle = currentColor;
        
        // Simple Brush Implementation
        if (tool === 'line') {
             ctx.lineWidth = brushSize;
             ctx.lineCap = 'round';
             ctx.lineTo(x, y);
             ctx.stroke();
             ctx.beginPath();
             ctx.moveTo(x, y);
        } else if (tool === 'spray') {
            for(let i=0; i<brushSize*2; i++) {
                const ox = (Math.random() - 0.5) * brushSize * 2;
                const oy = (Math.random() - 0.5) * brushSize * 2;
                ctx.fillRect(x+ox, y+oy, 1, 1);
            }
        } else {
             // Shapes
             ctx.beginPath();
             if(tool === 'round') ctx.arc(x, y, brushSize/2, 0, Math.PI*2);
             else if(tool === 'square') ctx.rect(x-brushSize/2, y-brushSize/2, brushSize, brushSize);
             else if(tool === 'triangle') {
                 ctx.moveTo(x, y-brushSize/2);
                 ctx.lineTo(x+brushSize/2, y+brushSize/2);
                 ctx.lineTo(x-brushSize/2, y+brushSize/2);
             }
             // For others, simplify to round for now or add complex logic
             else ctx.arc(x, y, brushSize/2, 0, Math.PI*2);
             
             ctx.fill();
        }
    };

    canvas.addEventListener('mousedown', (e) => {
        ctx.beginPath();
        const pos = getPos(e);
        ctx.moveTo(pos.x, pos.y);
        startDraw(e);
    });
    window.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mousemove', (e) => window.draw(e));
    
    canvas.addEventListener('touchstart', (e) => {
        ctx.beginPath();
        const pos = getPos(e);
        ctx.moveTo(pos.x, pos.y);
        startDraw(e);
    }, {passive: false});
    window.addEventListener('touchend', endDraw);
    canvas.addEventListener('touchmove', (e) => window.draw(e), {passive: false});

    // Controls
    colorPicker.addEventListener('input', (e) => currentColor = e.target.value);
    brushSizeSlider.addEventListener('input', (e) => {
        brushSize = parseInt(e.target.value);
        brushSizeVal.textContent = brushSize;
    });
    toolSelect.addEventListener('change', (e) => tool = e.target.value);
    
    window.setColor = (hex) => {
        currentColor = hex;
        colorPicker.value = hex;
    };

    window.clearCanvas = () => {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        saveState();
        showToast('Canvas Cleared', 'info');
    };

    window.undo = () => {
        if(undoStack.length > 1) {
            redoStack.push(undoStack.pop());
            const img = new Image();
            img.src = undoStack[undoStack.length-1];
            img.onload = () => ctx.drawImage(img, 0, 0);
        }
    };

    window.redo = () => {
        if(redoStack.length > 0) {
            const data = redoStack.pop();
            undoStack.push(data);
            const img = new Image();
            img.src = data;
            img.onload = () => ctx.drawImage(img, 0, 0);
        }
    };
    
    window.saveImage = () => {
        const link = document.createElement('a');
        link.download = 'synesthetica-art.png';
        link.href = canvas.toDataURL();
        link.click();
        showToast('Image Saved!', 'success');
    };

    // --- API Calls ---
    window.submitDrawing = async () => {
        const btn = document.querySelector('button[onclick="submitDrawing()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<span class="animate-spin mr-2">‚Üª</span> Generating...`;
        
        try {
            const res = await fetch('/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    image: canvas.toDataURL(),
                    brush: tool
                })
            });
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);
            
            const player = document.getElementById('player');
            player.src = data.url;
            player.play();
            
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('downloadBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            
            showToast('Music Generated Successfully!', 'success');
        } catch(e) {
            console.error(e);
            showToast(e.message || 'Generation Failed', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    };
    
    window.downloadAudio = () => {
        const player = document.getElementById('player');
        if(player.src) {
            const link = document.createElement('a');
            link.href = player.src;
            link.download = 'synesthetica-audio.wav';
            link.click();
        }
    };

    // Instrument Selector
    const instrumentSelect = document.getElementById('instrumentSelect');
    if (instrumentSelect) {
        instrumentSelect.addEventListener('change', (e) => {
            if (window.realTimeAudio) {
                window.realTimeAudio.setInstrument(e.target.value);
            }
        });
    }
</script>
{% endblock %}
